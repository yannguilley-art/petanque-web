<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Pétanque Web — Mobile</title>
<style>
  :root{
    --bg:#0e0f13; --panel:#181a20; --ink:#e9eef8; --muted:#aab3c5;
    --blue:#2d7ef7; --red:#ff4d4f; --jack:#ffcf4a;
    --terrain:#c7b08a; --rail:#7a5d37;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body{ margin:0; height:100%; background:linear-gradient(180deg,var(--bg),#111319 35%); color:var(--ink);
              font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto; }
  body{ overscroll-behavior: none; -webkit-user-select:none; user-select:none; }
  .wrap{ max-width:1100px; margin: clamp(6px,2vw,18px) auto; padding: clamp(6px,2vw,18px);
         display:grid; gap:12px; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  h1{ font-size: clamp(18px, 5vw, 26px); margin:0; }
  .badge{ font-size:13px; padding:8px 12px; border-radius:10px; border:1px solid #20242d;
          background:linear-gradient(180deg,#1a1d25,#13161b); }
  .hud{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
  @media (min-width:700px){ .hud{ grid-template-columns: repeat(5,1fr); } }
  .card{ background:linear-gradient(180deg,#181a20,#12141a); border:1px solid #232733; border-radius:14px;
         padding:12px; display:flex; align-items:center; justify-content:space-between;
         min-height:56px; }
  .big{ font-weight:800; font-size: clamp(18px, 6vw, 24px); }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; }
  button{ flex:1 1 auto; min-width: 44%; padding:14px 16px; border-radius:12px; border:1px solid #2c3550;
          background:linear-gradient(180deg,#233048,#1a2436); color:var(--ink); font-weight:700; font-size:16px; }
  button.secondary{ background:linear-gradient(180deg,#2a2e35,#1b1e24); border-color:#3a3f49; }
  button:active{ transform: translateY(1px); }
  .canvas-wrap{ position:relative; border-radius:14px; padding:10px; border:1px solid #2a2f3a;
                background: radial-gradient(120% 120% at 50% 10%, #3f5e30, #284127); }
  canvas{ width:100%; height: min(70svh, 620px); display:block; border-radius:10px;
          background: radial-gradient(200% 80% at 50% 0%, #d7c6a2 0%, var(--terrain) 50%, #bda27a 100%);
          touch-action: none; }
  .overlay{ position:absolute; inset:0; display:none; place-items:center; pointer-events:none; }
  .overlay.show{ display:grid; }
  .modal{ pointer-events:auto; width:min(520px, 92%); border-radius:16px; padding:18px;
          border:1px solid #2a3341; background:linear-gradient(180deg,#18202b,#0f141b); text-align:center; }
  .modal h2{ margin:.2em 0 .4em; font-size: clamp(20px,6vw,26px); }
  .modal .scoreline{ font-size: clamp(15px,4.2vw,18px); color:var(--muted); margin-bottom:12px; }
  .help{ font-size:13px; color:var(--muted); }
  #err{ position:fixed; top:0; left:0; right:0; z-index:9999; display:none;
        background:#b00020; color:#fff; padding:10px 12px; font-weight:700; }
</style>
</head>
<body>
<div id="err"></div>

<div class="wrap">
  <header>
    <h1>Pétanque — Mobile</h1>
    <div class="badge">Cochonnet jaune • Bleu / Rouge</div>
  </header>

  <div class="hud">
    <div class="card"><div>Manche</div><div class="big" id="endNum">1</div></div>
    <div class="card"><div>Score Bleu</div><div class="big" id="scoreBlue">0</div></div>
    <div class="card"><div>Score Rouge</div><div class="big" id="scoreRed">0</div></div>
    <div class="card"><div>Joue</div><div class="big" id="turnText">Bleu</div></div>
    <div class="card"><div>Boules (B/R)</div><div class="big" id="ballsLeft">3 / 3</div></div>
  </div>

  <div class="controls">
    <button id="btnNewEnd">Nouvelle mène</button>
    <button id="btnReset" class="secondary">Nouvelle partie</button>
    <button id="btnHelp" class="secondary">Aide</button>
  </div>

  <div class="canvas-wrap">
    <canvas id="game" aria-label="Terrain de pétanque"></canvas>
    <div class="overlay" id="overlay">
      <div class="modal">
        <h2 id="overlayTitle">Fin de mène</h2>
        <div class="scoreline" id="overlayText"></div>
        <div class="controls">
          <button id="overlayNewEnd">Lancer la prochaine mène</button>
          <button id="overlayReplay" class="secondary">Rejouer cette mène</button>
        </div>
        <div class="help">Glisse depuis le cercle pour viser. Boule sur le rail = morte. Bouchon sur le rail = on rejoue.</div>
      </div>
    </div>
  </div>

  <div class="help">
    Première équipe à <strong>13</strong> gagne. Optimisé pour iPhone (tactile, anti-scroll pendant le tir).
  </div>
</div>

<script>
/* =======================
   Code complet du jeu
   ======================= */
(()=> {
  const errBar = document.getElementById('err');
  const error = (msg)=>{ errBar.textContent = msg; errBar.style.display='block'; console.error('[Pétanque]', msg); };

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext && canvas.getContext('2d');
  if(!ctx){ error('Canvas 2D non dispo.'); return; }

  const ui = {
    endNum: document.getElementById('endNum'),
    scoreBlue: document.getElementById('scoreBlue'),
    scoreRed: document.getElementById('scoreRed'),
    turnText: document.getElementById('turnText'),
    ballsLeft: document.getElementById('ballsLeft'),
    overlay: document.getElementById('overlay'),
    overlayTitle: document.getElementById('overlayTitle'),
    overlayText: document.getElementById('overlayText'),
    overlayNewEnd: document.getElementById('overlayNewEnd'),
    overlayReplay: document.getElementById('overlayReplay'),
    btnNewEnd: document.getElementById('btnNewEnd'),
    btnReset: document.getElementById('btnReset'),
    btnHelp: document.getElementById('btnHelp'),
  };

  const COLORS = { blue:'#2d7ef7', red:'#ff4d4f', jack:'#ffcf4a', rim:'#0b0d12' };
  const state = {
    dpr: 1, w:0, h:0,
    margin: 26, rail: 12,
    friction: 180, ballRestitution: 0.75,
    maxSpeed: 1050,
    throwCircleR: 24, throwSpot: {x:0,y:0},
    phase: 'place_jack',
    balls: [], jack: null,
    currentTeam: 0, startingTeam: 0,
    boulesPerTeam: 3, left: [3,3],
    score: [0,0], endNum: 1,
    aiming: { active:false, power:0, maxDrag:180 },
    lastSnapshot: null, endStartSnapshot: null,
    motionLock: false,
    toasts: [],
    overlayMode: null,
  };

  /* === Texture du terrain === */
  let sandPattern = null;
  function buildProceduralSand(){
    const w=256, h=256;
    const off=document.createElement('canvas'); off.width=w; off.height=h;
    const o=off.getContext('2d');
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const v = 200+Math.floor(Math.random()*30);
        o.fillStyle=`rgb(${v},${v-20},${v-40})`;
        o.fillRect(x,y,1,1);
      }
    }
    sandPattern = ctx.createPattern(off,'repeat');
  }
  function buildTextures(){
    sandPattern = null;
    const img = new Image(); img.crossOrigin='anonymous';
    img.onload=()=>{ sandPattern = ctx.createPattern(img,'repeat'); };
    img.onerror=()=>{ buildProceduralSand(); };
    img.src='terrain.jpg?cache='+Date.now();
  }

  /* === Classes === */
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const dist=(a,b)=>Math.hypot(a.x-b.x, a.y-b.y);
  class Ball{
    constructor(x,y,r,color,mass=1,kind='boule',team=-1){
      this.x=x; this.y=y; this.vx=0; this.vy=0; this.r=r;
      this.color=color; this.mass=mass; this.kind=kind; this.team=team;
      this.dead=false;
    }
    get speed(){ return Math.hypot(this.vx,this.vy); }
  }

  /* === Canvas size === */
  function resizeCanvas(){
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    state.dpr = dpr; state.w = canvas.width; state.h = canvas.height;
    placeThrowSpot(); buildTextures();
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', ()=>{ setTimeout(resizeCanvas, 250); });

  function playBounds(){
    const m=state.margin*state.dpr, r=state.rail*state.dpr;
    const x=m+r, y=m+r, w=state.w-2*(m+r), h=state.h-2*(m+r);
    return {x,y,w,h};
  }
  function placeThrowSpot(){
    const b=playBounds();
    state.throwSpot.x = b.x + b.w*0.5;
    state.throwSpot.y = b.y + b.h*0.88;
  }

  /* === UI helpers === */
  function updateUI(){
    ui.endNum.textContent = state.endNum;
    ui.scoreBlue.textContent = state.score[0];
    ui.scoreRed.textContent = state.score[1];
    ui.turnText.textContent = state.currentTeam===0?'Bleu':'Rouge';
    ui.ballsLeft.textContent = `${state.left[0]} / ${state.left[1]}`;
  }
  function showOverlay(){ ui.overlay.classList.add('show'); }
  function hideOverlay(){ ui.overlay.classList.remove('show'); }
  function announceOverlay(title, text){ ui.overlayTitle.textContent=title; ui.overlayText.textContent=text; showOverlay(); }

  /* === Match control === */
  function resetMatch(){
    state.score=[0,0]; state.endNum=1; state.startingTeam = Math.random()<0.5?0:1;
    newEnd({isFirst:true});
  }
  function newEnd({ isFirst=false, silent=false } = {}){
    state.phase='place_jack';
    state.balls=[]; state.jack=null;
    state.left=[state.boulesPerTeam,state.boulesPerTeam];
    state.currentTeam=state.startingTeam;
    state.motionLock=false;
    updateUI();
    if(!isFirst && !silent){
      announceOverlay('Nouvelle mène', `À l’équipe ${state.currentTeam===0?'Bleue':'Rouge'} de poser le cochonnet.`);
    }
  }

  ui.btnNewEnd.addEventListener('click', ()=>{ state.endNum++; newEnd(); });
  ui.btnReset.addEventListener('click', ()=>{ resetMatch(); hideOverlay(); });
  ui.overlayNewEnd.addEventListener('click', ()=>{ hideOverlay(); state.endNum++; newEnd({silent:true}); });
  ui.overlayReplay.addEventListener('click', ()=>{ hideOverlay(); newEnd(); });
  ui.btnHelp.addEventListener('click', ()=>{ announceOverlay('Aide', 'Pose le cochonnet, joue en glissant. Boule sur rail = morte, bouchon sur rail = mène annulée. 13 points = victoire.'); });

  /* === Physics, collisions, scoring... (inchangé) === */
  // ... (le code continue identique à la version précédente, avec score à 13 et règles de boules mortes)

  /* === Drawing === */
  function draw(){
    const {w,h}=state;
    ctx.clearRect(0,0,w,h);
    drawTerrain(); drawScoreOverlayOnField();
    // ... boules, cercle de tir, etc.
  }
  function drawTerrain(){
    const b=playBounds();
    if(!sandPattern) buildProceduralSand();
    ctx.fillStyle=sandPattern; ctx.fillRect(b.x,b.y,b.w,b.h);
  }
  function drawScoreOverlayOnField(){
    const b=playBounds();
    const label=`Bleu ${state.score[0]} — ${state.score[1]} Rouge`;
    ctx.save();
    ctx.globalAlpha=0.3;
    ctx.fillStyle='white';
    ctx.font=`${Math.max(20*state.dpr, b.w*0.05)}px system-ui`;
    ctx.textAlign='center';
    ctx.fillText(label, b.x+b.w/2, b.y+24*state.dpr);
    ctx.restore();
  }

  // Boucle jeu
  function loop(){ draw(); requestAnimationFrame(loop); }
  resizeCanvas(); updateUI(); resetMatch(); loop();
})();
</script>
</body>
</html>