<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Pétanque — Terrain réaliste + Score incrusté</title>
<style>
  :root{
    --bg:#0e0f13; --panel:#181a20; --ink:#e9eef8; --muted:#aab3c5;
    --blue:#2d7ef7; --red:#ff4d4f; --jack:#ffcf4a;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body{ margin:0; height:100%; background:linear-gradient(180deg,var(--bg),#111319 35%); color:var(--ink);
              font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto; }
  body{ overscroll-behavior:none; -webkit-user-select:none; user-select:none; }
  .wrap{ max-width:1100px; margin:clamp(6px,2vw,18px) auto; padding:clamp(6px,2vw,18px); display:grid; gap:12px; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  h1{ font-size:clamp(18px,5vw,26px); margin:0; }
  .hud{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
  @media (min-width:700px){ .hud{ grid-template-columns:repeat(5,1fr);} }
  .card{ background:linear-gradient(180deg,#181a20,#12141a); border:1px solid #232733; border-radius:14px;
         padding:12px; display:flex; align-items:center; justify-content:space-between; min-height:56px; }
  .big{ font-weight:800; font-size:clamp(18px,6vw,24px); }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button{ flex:1 1 auto; min-width:44%; padding:14px 16px; border-radius:12px; border:1px solid #2c3550;
          background:linear-gradient(180deg,#233048,#1a2436); color:var(--ink); font-weight:700; font-size:16px; }
  button.secondary{ background:linear-gradient(180deg,#2a2e35,#1b1e24); border-color:#3a3f49; }
  .canvas-wrap{ position:relative; border-radius:14px; padding:10px; border:1px solid #2a2f3a;
                background: radial-gradient(120% 120% at 50% 10%, #3f5e30, #284127); }
  canvas{ width:100%; height:min(70svh,620px); display:block; border-radius:12px; touch-action:none; }
  .overlay{ position:absolute; inset:0; display:none; place-items:center; pointer-events:none; }
  .overlay.show{ display:grid; }
  .modal{ pointer-events:auto; width:min(520px,92%); border-radius:16px; padding:18px;
          border:1px solid #2a3341; background:linear-gradient(180deg,#18202b,#0f141b); text-align:center; }
  .modal h2{ margin:.2em 0 .4em; font-size:clamp(20px,6vw,26px); }
  .help{ font-size:13px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Pétanque — Mobile</h1>
    <div class="help">Glisse depuis le cercle pour tirer.</div>
  </header>

  <div class="hud">
    <div class="card"><div>Manche</div><div class="big" id="endNum">1</div></div>
    <div class="card"><div>Score Bleu</div><div class="big" id="scoreBlue">0</div></div>
    <div class="card"><div>Score Rouge</div><div class="big" id="scoreRed">0</div></div>
    <div class="card"><div>Joue</div><div class="big" id="turnText">Bleu</div></div>
    <div class="card"><div>Boules (B/R)</div><div class="big" id="ballsLeft">3 / 3</div></div>
  </div>

  <div class="controls">
    <button id="btnNewEnd">Nouvelle mène</button>
    <button id="btnReset" class="secondary">Nouvelle partie</button>
    <button id="btnHelp" class="secondary">Aide</button>
  </div>

  <div class="canvas-wrap">
    <canvas id="game" aria-label="Terrain de pétanque"></canvas>
    <div class="overlay" id="overlay">
      <div class="modal">
        <h2 id="overlayTitle">Fin de mène</h2>
        <div id="overlayText" class="help"></div>
        <div class="controls" style="margin-top:10px">
          <button id="overlayNewEnd">Lancer la prochaine mène</button>
          <button id="overlayReplay" class="secondary">Rejouer cette mène</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=> {
  // ---------- UI ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const ui = {
    endNum: document.getElementById('endNum'),
    scoreBlue: document.getElementById('scoreBlue'),
    scoreRed: document.getElementById('scoreRed'),
    turnText: document.getElementById('turnText'),
    ballsLeft: document.getElementById('ballsLeft'),
    overlay: document.getElementById('overlay'),
    overlayTitle: document.getElementById('overlayTitle'),
    overlayText: document.getElementById('overlayText'),
    overlayNewEnd: document.getElementById('overlayNewEnd'),
    overlayReplay: document.getElementById('overlayReplay'),
    btnNewEnd: document.getElementById('btnNewEnd'),
    btnReset: document.getElementById('btnReset'),
    btnHelp: document.getElementById('btnHelp'),
  };

  const COLORS = { blue:'#2d7ef7', red:'#ff4d4f', jack:'#ffcf4a', rim:'#0b0d12' };

  // ---------- State ----------
  const S = {
    dpr:1, w:0, h:0,
    margin:28, rail:14,
    friction:180, e:0.75, maxSpeed:1050,
    throwCircleR:24, throwSpot:{x:0,y:0},
    phase:'place_jack',
    balls:[], jack:null,
    currentTeam:0, startingTeam:0,
    perTeam:3, left:[3,3],
    score:[0,0], end:1,
    aiming:{active:false,power:0,maxDrag:180},
    motionLock:false,
    lastSnapshot:null
  };

  class Ball{
    constructor(x,y,r,c,m=1,kind='boule',team=-1){
      this.x=x; this.y=y; this.vx=0; this.vy=0; this.r=r;
      this.color=c; this.mass=m; this.kind=kind; this.team=team; this.dead=false;
    }
    get speed(){ return Math.hypot(this.vx,this.vy); }
  }

  // ---------- Layout ----------
  function resize(){
    const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    const cssW=canvas.clientWidth, cssH=canvas.clientHeight;
    canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
    S.dpr=dpr; S.w=canvas.width; S.h=canvas.height;
    placeThrowSpot();
  }
  function playBounds(){
    const m=S.margin*S.dpr, r=S.rail*S.dpr;
    return {x:m+r, y:m+r, w:S.w-2*(m+r), h:S.h-2*(m+r)};
  }
  function placeThrowSpot(){
    const b=playBounds();
    S.throwSpot.x=b.x+b.w*0.5;
    S.throwSpot.y=b.y+b.h*0.88;
  }
  window.addEventListener('resize', resize, {passive:true});
  window.addEventListener('orientationchange', ()=>setTimeout(resize,250), {passive:true});

  // ---------- Snapshots ----------
  const snap=()=>JSON.stringify({
    phase:S.phase,
    balls:S.balls.map(b=>({x:b.x,y:b.y,vx:b.vx,vy:b.vy,r:b.r,c:b.color,m:b.mass,k:b.kind,t:b.team})),
    currentTeam:S.currentTeam, startingTeam:S.startingTeam,
    left:[...S.left], score:[...S.score], end:S.end
  });
  const loadSnap=(j)=>{
    const a=JSON.parse(j);
    S.phase=a.phase;
    S.balls=a.balls.map(o=>{const b=new Ball(o.x,o.y,o.r,o.c,o.m,o.k,o.t); b.vx=o.vx; b.vy=o.vy; if(o.k==='jack') S.jack=b; return b;});
    S.currentTeam=a.currentTeam; S.startingTeam=a.startingTeam;
    S.left=a.left; S.score=a.score; S.end=a.end; S.motionLock=false; hideOverlay(); uiSync();
  };

  // ---------- UI helpers ----------
  const teamName=i=> i===0?'Bleue':'Rouge';
  function uiSync(){
    ui.endNum.textContent=S.end;
    ui.scoreBlue.textContent=S.score[0];
    ui.scoreRed.textContent=S.score[1];
    ui.turnText.textContent=S.currentTeam===0?'Bleu':'Rouge';
    ui.ballsLeft.textContent=`${S.left[0]} / ${S.left[1]}`;
  }
  const showOverlay=()=>ui.overlay.classList.add('show');
  const hideOverlay=()=>ui.overlay.classList.remove('show');
  function announceOverlay(t,txt){ ui.overlayTitle.textContent=t; ui.overlayText.textContent=txt; showOverlay(); }

  // ---------- Controls ----------
  function resetMatch(){
    S.score=[0,0]; S.end=1; S.startingTeam = Math.random()<0.5?0:1;
    newEnd({isFirst:true});
  }
  function newEnd({isFirst=false, silent=false}={}){
    S.phase='place_jack'; S.balls=[]; S.jack=null;
    S.left=[S.perTeam,S.perTeam]; S.currentTeam=S.startingTeam; S.motionLock=false; uiSync();
    const s=snap(); S.lastSnapshot=s;
    if(!isFirst && !silent){ announceOverlay('Nouvelle mène', `À l’équipe ${teamName(S.currentTeam)} de poser le cochonnet.`); }
  }
  function replayEnd(){ if(S.lastSnapshot) loadSnap(S.lastSnapshot); }

  ui.btnNewEnd.addEventListener('click', ()=>{ S.end++; newEnd(); });
  ui.btnReset.addEventListener('click', ()=>{ resetMatch(); hideOverlay(); });
  ui.overlayNewEnd.addEventListener('click', ()=>{ hideOverlay(); S.end++; newEnd({silent:true}); });
  ui.overlayReplay.addEventListener('click', ()=>{ hideOverlay(); replayEnd(); });
  ui.btnHelp.addEventListener('click', ()=>announceOverlay('Aide', 'Glisse depuis le cercle pour viser. Boule sur le bois = morte. Cochonnet sur le bois = mène annulée. 13 points pour gagner.'));

  // ---------- Physics ----------
  function resolveCollision(a,b){
    const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), min=a.r+b.r;
    if(d===0||d>min) return;
    const nx=dx/(d||1), ny=dy/(d||1);
    const overlap=(min-d)+0.01, tm=a.mass+b.mass;
    a.x-=nx*overlap*(b.mass/tm); a.y-=ny*overlap*(b.mass/tm);
    b.x+=nx*overlap*(a.mass/tm); b.y+=ny*overlap*(a.mass/tm);
    const rvx=b.vx-a.vx, rvy=b.vy-a.vy, vn=rvx*nx+rvy*ny; if(vn>0) return;
    const j=-(1+S.e)*vn/(1/a.mass+1/b.mass), ix=j*nx, iy=j*ny;
    a.vx-=ix/a.mass; a.vy-=iy/a.mass; b.vx+=ix/b.mass; b.vy+=iy/b.mass;
  }
  const anyMoving=()=>S.balls.some(b=>b.speed>5);

  function update(dt){
    const bounds=playBounds();
    for(const b of S.balls){
      if(b.dead) continue;
      const s=b.speed, dec=S.friction*dt;
      if(s>0){ if(s<=dec){ b.vx=b.vy=0; } else { const f=1-dec/s; b.vx*=f; b.vy*=f; } }
      b.x+=b.vx*dt; b.y+=b.vy*dt;

      // Bord = bois
      const hit = (b.x-b.r<=bounds.x||b.x+b.r>=bounds.x+b.w||b.y-b.r<=bounds.y||b.y+b.r>=bounds.y+b.h);
      if(!hit) continue;

      if(b.kind==='boule'){
        b.dead=true;
        // petit "pouf" visuel
        particles.push({x:b.x,y:b.y,ttl:.45});
        b.vx=b.vy=0;
      } else {
        announceOverlay('Mène annulée','Le cochonnet a touché le bord. On rejoue en reposant le cochonnet.');
        setTimeout(()=>{ hideOverlay(); newEnd({silent:true}); },700);
        S.motionLock=false; return;
      }
    }
    if(S.balls.some(b=>b.dead)) S.balls=S.balls.filter(b=>!b.dead);
    for(let i=0;i<S.balls.length;i++) for(let j=i+1;j<S.balls.length;j++) resolveCollision(S.balls[i],S.balls[j]);
    updateParticles(dt);
  }

  // ---------- Turns & scoring ----------
  const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
  function nearest(team){
    const jack=S.jack; if(!jack) return Infinity;
    let best=Infinity; for(const b of S.balls){ if(b.kind==='boule'&&b.team===team){ best=Math.min(best, dist(b,jack)); } }
    return best;
  }
  function decideNext(){
    const L=S.left, d0=nearest(0), d1=nearest(1);
    if(!isFinite(d0)&&!isFinite(d1)){ if(L[S.currentTeam]>0) return S.currentTeam; if(L[1-S.currentTeam]>0) return 1-S.currentTeam; }
    let far=d0>d1?0:1; if(Math.abs(d0-d1)<0.1) far=S.currentTeam;
    if(L[far]>0) return far; if(L[1-far]>0) return 1-far; return null;
  }
  function scoreEnd(){
    const dB=nearest(0), dR=nearest(1);
    let winner=(dR<dB)?1:0; if(!isFinite(dB)&&isFinite(dR)) winner=1; if(!isFinite(dR)&&isFinite(dB)) winner=0;
    const opp=winner===0?dR:dB; let pts=0;
    for(const b of S.balls){ if(b.kind==='boule'&&b.team===winner){ if(dist(b,S.jack)+0.05<opp) pts++; } }
    return {winner, points:pts};
  }
  function afterStop(){
    if(S.phase==='place_jack'){ S.phase='play'; S.currentTeam=S.startingTeam; S.motionLock=false; uiSync(); return; }
    if(S.phase!=='play') return;
    const next=decideNext();
    if(next===null){
      const r=scoreEnd();
      S.score[r.winner]+=r.points;
      if(S.score[r.winner]>=13){
        S.phase='match_over';
        announceOverlay('Partie gagnée', `Bravo ! Équipe ${teamName(r.winner)} atteint 13 (Bleu ${S.score[0]} — Rouge ${S.score[1]}).`);
        return;
      }
      S.startingTeam=r.winner; uiSync();
      announceOverlay('Fin de mène', `Équipe ${teamName(r.winner)} marque ${r.points} point${r.points>1?'s':''}.`);
      S.phase='scoring'; S.motionLock=false;
    } else { S.currentTeam=next; S.motionLock=false; uiSync(); }
  }

  // ---------- Input (tactile) ----------
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const pointer={x:0,y:0};
  function pt(e){
    const r=canvas.getBoundingClientRect();
    const t=(e.touches&&e.touches[0])||(e.changedTouches&&e.changedTouches[0])||e;
    return {x:(t.clientX-r.left)*S.dpr, y:(t.clientY-r.top)*S.dpr};
  }
  function start(e){
    e.preventDefault(); if(S.motionLock||anyMoving()) return;
    const p=pt(e); pointer.x=p.x; pointer.y=p.y; S.aiming.active=true; S.aiming.power=0;
  }
  function move(e){
    if(!S.aiming.active) return; e.preventDefault();
    const p=pt(e); pointer.x=p.x; pointer.y=p.y;
    const dx=S.throwSpot.x-pointer.x, dy=S.throwSpot.y-pointer.y;
    const drag=clamp(Math.hypot(dx,dy),0,S.aiming.maxDrag*S.dpr);
    S.aiming.power=drag/(S.aiming.maxDrag*S.dpr);
  }
  function end(e){
    if(!S.aiming.active) return; e.preventDefault();
    if(S.motionLock||anyMoving()){ S.aiming.active=false; return; }
    S.aiming.active=false;
    const p=pt(e); const dx=S.throwSpot.x-p.x, dy=S.throwSpot.y-p.y;
    const drag=Math.hypot(dx,dy); if(drag<8*S.dpr) return;
    const dirx=dx/drag, diry=dy/drag;
    const speed=clamp(S.maxSpeed*(drag/(S.aiming.maxDrag*S.dpr)),120,S.maxSpeed);

    if(S.phase==='place_jack'){
      if(!S.jack){ const r=6*S.dpr; const j=new Ball(S.throwSpot.x,S.throwSpot.y,r,COLORS.jack,0.5,'jack'); S.jack=j; S.balls.push(j); }
      S.jack.vx=dirx*speed; S.jack.vy=diry*speed; S.motionLock=true;
    } else if(S.phase==='play'){
      if(!S.jack) return;
      if(S.left[S.currentTeam]<=0) return;
      const r=12*S.dpr; const col=S.currentTeam===0?COLORS.blue:COLORS.red;
      const b=new Ball(S.throwSpot.x,S.throwSpot.y,r,col,1.8,'boule',S.currentTeam);
      b.vx=dirx*speed; b.vy=diry*speed; S.balls.push(b);
      S.left[S.currentTeam]--; S.motionLock=true; uiSync();
    }
  }
  if('onpointerdown' in window){
    canvas.addEventListener('pointerdown', start, {passive:false});
    canvas.addEventListener('pointermove', move, {passive:false});
    window.addEventListener('pointerup', end, {passive:false});
  } else {
    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end, {passive:false});
    window.addEventListener('touchcancel', ()=>{ S.aiming.active=false; }, {passive:true});
  }

  // ---------- Particles (pouf) ----------
  const particles=[];
  function updateParticles(dt){
    for(const p of particles){ p.ttl-=dt; }
    for(let i=particles.length-1;i>=0;i--) if(particles[i].ttl<=0) particles.splice(i,1);
  }
  function drawPouf(p){
    const a = Math.max(0, Math.min(1, p.ttl/0.45));
    const R = (20 + 30*(1-a)) * S.dpr;
    const g = ctx.createRadialGradient(p.x,p.y,0, p.x,p.y,R);
    g.addColorStop(0, 'rgba(255,255,255,'+(0.20*a)+')');
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,R,0,Math.PI*2); ctx.fill();
  }

  // ---------- Rendering: terrain réaliste ----------
  // Génère une texture sable (bruit) + veinage bois + ombres d’arbres + vignette
  let sandTex=null, woodTex=null;
  function buildTextures(){
    const off=document.createElement('canvas');
    off.width = Math.max(512, Math.floor(S.w/2)); off.height = Math.max(512, Math.floor(S.h/2));
    const octx=off.getContext('2d');

    // sable
    const imgData=octx.createImageData(off.width, off.height);
    for(let i=0;i<imgData.data.length;i+=4){
      const n = Math.random(); // bruit simple
      const base = 204 + Math.floor(n*26); // beige
      imgData.data[i]=base; imgData.data[i+1]= 180 + Math.floor(n*10); imgData.data[i+2]= 140 + Math.floor(n*12); imgData.data[i+3]=255;
    }
    octx.putImageData(imgData,0,0);
    // stries fines
    octx.globalAlpha=0.18;
    octx.fillStyle='#b89a73';
    for(let y=0;y<off.height;y+=3){ octx.fillRect(0,y,off.width,1); }
    octx.globalAlpha=1;
    sandTex=off;

    // bois
    const wood=document.createElement('canvas'); wood.width=512; wood.height=64;
    const wctx=wood.getContext('2d');
    const grd=wctx.createLinearGradient(0,0,512,0);
    grd.addColorStop(0,'#6e5333'); grd.addColorStop(1,'#8a6a43');
    wctx.fillStyle=grd; wctx.fillRect(0,0,512,64);
    wctx.globalAlpha=0.25; wctx.fillStyle='rgba(255,255,255,.08)';
    for(let x=0;x<512;x+=16){ wctx.fillRect(x,0,2,64); }
    wctx.globalAlpha=0.35; wctx.fillStyle='rgba(0,0,0,.25)';
    for(let x=8;x<512;x+=20){ wctx.fillRect(x,0,1,64); }
    wctx.globalAlpha=1;
    woodTex=wood;
  }

  function drawTerrain(){
    const b=playBounds();

    // rails bois (haut/bas/gauche/droite) avec texture répétée
    const tileW=woodTex.width, tileH=woodTex.height;
    ctx.save();
    // haut
    for(let x=b.x-S.rail*S.dpr; x<b.x+b.w+S.rail*S.dpr; x+=tileW){
      ctx.drawImage(woodTex, x, b.y-S.rail*S.dpr, tileW, S.rail*S.dpr);
    }
    // bas
    for(let x=b.x-S.rail*S.dpr; x<b.x+b.w+S.rail*S.dpr; x+=tileW){
      ctx.drawImage(woodTex, x, b.y+b.h, tileW, S.rail*S.dpr);
    }
    // gauche
    ctx.save(); ctx.translate(b.x-S.rail*S.dpr, b.y); ctx.rotate(-Math.PI/2);
    for(let y=0; y<b.h; y+=tileW){ ctx.drawImage(woodTex, -tileW, y, tileW, S.rail*S.dpr); }
    ctx.restore();
    // droite
    ctx.save(); ctx.translate(b.x+b.w+S.rail*S.dpr, b.y); ctx.rotate(Math.PI/2);
    for(let y=0; y<b.h; y+=tileW){ ctx.drawImage(woodTex, 0, -y-S.rail*S.dpr, tileW, S.rail*S.dpr); }
    ctx.restore();
    ctx.restore();

    // texture sable (pattern)
    const pattern = ctx.createPattern(sandTex, 'repeat');
    ctx.fillStyle=pattern; ctx.fillRect(b.x,b.y,b.w,b.h);

    // taches/aspérités
    ctx.save();
    ctx.globalAlpha=0.2;
    ctx.fillStyle='#9d8664';
    const step=10*S.dpr;
    for(let y=b.y;y<b.y+b.h;y+=step){
      for(let x=b.x + ((y/step|0)%2 ? step/2 : 0); x<b.x+b.w; x+=step){
        ctx.fillRect(x, y, 1.2*S.dpr, 1.2*S.dpr);
      }
    }
    ctx.restore();

    // ombres d’arbres latérales (ambiance)
    const shadowW=60*S.dpr;
    const lgL=ctx.createLinearGradient(b.x,0,b.x+shadowW,0);
    lgL.addColorStop(0,'rgba(0,0,0,.28)'); lgL.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=lgL; ctx.fillRect(b.x, b.y, shadowW, b.h);
    const lgR=ctx.createLinearGradient(b.x+b.w,0,b.x+b.w-shadowW,0);
    lgR.addColorStop(0,'rgba(0,0,0,.25)'); lgR.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=lgR; ctx.fillRect(b.x+b.w-shadowW, b.y, shadowW, b.h);

    // vignette douce
    ctx.save();
    const vign=ctx.createRadialGradient(S.w/2,S.h/2, Math.min(S.w,S.h)*0.2, S.w/2,S.h/2, Math.max(S.w,S.h)*0.65);
    vign.addColorStop(0,'rgba(0,0,0,0)');
    vign.addColorStop(1,'rgba(0,0,0,.25)');
    ctx.fillStyle=vign; ctx.fillRect(0,0,S.w,S.h);
    ctx.restore();

    // bord du terrain (trait fin)
    ctx.strokeStyle='rgba(20,22,28,.35)'; ctx.lineWidth=1*S.dpr;
    ctx.strokeRect(b.x+1*S.dpr, b.y+1*S.dpr, b.w-2*S.dpr, b.h-2*S.dpr);
  }

  // ---------- Overlay Score incrusté sur le terrain ----------
  function drawScoreOnField(){
    const b=playBounds();
    const centerX=b.x+b.w/2;
    const topY=b.y + 28*S.dpr;
    const text=`Bleu ${S.score[0]} — ${S.score[1]} Rouge`;
    ctx.save();
    ctx.font = `${Math.max(22*S.dpr, b.w*0.06)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign='center'; ctx.textBaseline='top';

    // halo sombre
    ctx.globalAlpha=0.28;
    ctx.fillStyle='#000';
    ctx.fillText(text, centerX+1.5*S.dpr, topY+1.5*S.dpr);

    // texte “gravé” semi-transparent
    ctx.globalAlpha=0.32;
    const grad=ctx.createLinearGradient(0,topY,0,topY+50*S.dpr);
    grad.addColorStop(0,'rgba(255,255,255,.7)');
    grad.addColorStop(1,'rgba(255,255,255,.35)');
    ctx.fillStyle=grad;
    ctx.fillText(text, centerX, topY);

    ctx.restore();
  }

  // ---------- Draw helpers ----------
  function drawBall(b){
    ctx.save(); ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=8*S.dpr; ctx.shadowOffsetY=2*S.dpr;
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle=b.color; ctx.fill(); ctx.restore();
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.lineWidth=2*S.dpr; ctx.strokeStyle=COLORS.rim; ctx.stroke();
    const g=ctx.createRadialGradient(b.x-b.r*0.45,b.y-b.r*0.45,b.r*0.15,b.x,b.y,b.r);
    g.addColorStop(0,'rgba(255,255,255,.5)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  }
  function drawThrowCircle(){
    const c=S.throwSpot, R=S.throwCircleR*S.dpr;
    ctx.save();
    ctx.beginPath(); ctx.arc(c.x,c.y,R,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2.5*S.dpr; ctx.stroke();
    ctx.beginPath(); ctx.arc(c.x,c.y,R-3*S.dpr,0,Math.PI*2); ctx.setLineDash([6*S.dpr,8*S.dpr]); ctx.strokeStyle='rgba(255,255,255,.16)'; ctx.lineWidth=1.5*S.dpr; ctx.stroke();
    ctx.restore();
  }
  function drawTurnMarker(){
    const c=S.throwSpot, R=S.throwCircleR*S.dpr, col=S.currentTeam===0?COLORS.blue:COLORS.red;
    ctx.save(); ctx.beginPath(); ctx.arc(c.x, c.y-R-10*S.dpr, 6*S.dpr, 0, Math.PI*2); ctx.fillStyle=col; ctx.fill(); ctx.restore();
  }

  // ---------- Loop ----------
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    update(dt);
    ctx.clearRect(0,0,S.w,S.h);
    drawTerrain();                // terrain réaliste
    drawScoreOnField();           // score incrusté translucide
    drawThrowCircle();
    for(const b of S.balls) drawBall(b);
    for(const p of particles) drawPouf(p);
    if(S.aiming.active) drawAim();
    drawTurnMarker();
    if(S.motionLock && !anyMoving()){ S.motionLock=false; afterStop(); }
    requestAnimationFrame(loop);
  }
  function drawAim(){
    const c=S.throwSpot, dx=c.x-pointer.x, dy=c.y-pointer.y;
    const L=clamp(Math.hypot(dx,dy),0,S.aiming.maxDrag*S.dpr), dirx=dx/(L||1), diry=dy/(L||1);
    ctx.save(); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=3*S.dpr;
    ctx.beginPath(); ctx.moveTo(c.x,c.y); ctx.lineTo(c.x-dirx*L, c.y-diry*L); ctx.stroke();
    const ax=c.x-dirx*L, ay=c.y-diry*L, head=10*S.dpr+4*S.aiming.power;
    ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(ax+(-diry)*head, ay+(dirx)*head); ctx.lineTo(ax+(diry)*head, ay+(-dirx)*head); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,.85)'; ctx.fill();
    // jauge
    const bw=130*S.dpr, bh=8*S.dpr, px=c.x-bw/2, py=c.y+(S.throwCircleR+14)*S.dpr;
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(px,py,bw,bh);
    ctx.fillStyle= S.phase==='place_jack' ? COLORS.jack : (S.currentTeam===0?COLORS.blue:COLORS.red);
    ctx.fillRect(px,py,bw*S.aiming.power,bh);
    ctx.restore();
  }

  // ---------- Start ----------
  function uiInit(){ uiSync(); }
  function boot(){ resize(); buildTextures(); uiInit(); resetMatch(); requestAnimationFrame(loop); }
  boot();
})();
</script>
</body>
</html>
